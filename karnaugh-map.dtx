% \iffalse meta-comment
% Copyright (C) 2015-2022 Mattias Jacobsson and contributors
% This work, karnaugh-map, is written from the ground up by Mattias Jacobsson. However the general implementation idea is based on the work published on [TeX - LaTeX Stack Exchange](https://tex.stackexchange.com) by [Ignasi](https://tex.stackexchange.com/users/1952/ignasi) found [here](https://tex.stackexchange.com/a/140581) and [here](https://tex.stackexchange.com/a/36879) which is licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). karnaugh-map is therefore licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). Contributors include [Oscar Gustafsson](https://github.com/oscargus) and [Paul Hervot](https://github.com/Dettorer).
% \fi
%
% \iffalse
%
%<package>
%<package>%%
%<package>%% Copyright (C) 2015-2022 Mattias Jacobsson and contributors
%<package>%% This work, karnaugh-map, is written from the ground up by Mattias Jacobsson. However the general implementation idea is based on the work published on [TeX - LaTeX Stack Exchange](https://tex.stackexchange.com) by [Ignasi](https://tex.stackexchange.com/users/1952/ignasi) found [here](https://tex.stackexchange.com/a/140581) and [here](https://tex.stackexchange.com/a/36879) which is licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). karnaugh-map is therefore licensed under [CC BY-SA](https://creativecommons.org/licenses/by-sa/3.0/). Contributors include [Oscar Gustafsson](https://github.com/oscargus) and [Paul Hervot](https://github.com/Dettorer).
%<package>%%
%<package>
%<package>\NeedsTeXFormat{LaTeX2e}
%<package>\ProvidesPackage{karnaugh-map}[2026/01/31 v2.1 Draw Karnaugh Maps]
%
%<*driver>
  \documentclass{ltxdoc}
  \usepackage{multicol}% for documentation
  \usepackage{tabularx}% for documentation
  \usepackage{float}% for documentation
  \usepackage{hyperref}% for documentation
  \usepackage{graphicx}% for documentation
  \usepackage{karnaugh-map}
  \setlength{\parindent}{0pt}
  \setlength{\parskip}{0.6em}
  \EnableCrossrefs
  \CodelineIndex
  \RecordChanges
  \OnlyDescription
  \begin{document}
    \DocInput{karnaugh-map.dtx}
    \PrintChanges
  \end{document}
%</driver>
% \fi
%
% \CharacterTable
%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%   Digits        \0\1\2\3\4\5\6\7\8\9
%   Exclamation   \!     Double quote  \"     Hash (number) \#
%   Dollar        \$     Percent       \%     Ampersand     \&
%   Acute accent  \'     Left paren    \(     Right paren   \)
%   Asterisk      \*     Plus          \+     Comma         \,
%   Minus         \-     Point         \.     Solidus       \/
%   Colon         \:     Semicolon     \;     Less than     \<
%   Equals        \=     Greater than  \>     Question mark \?
%   Commercial at \@     Left bracket  \[     Backslash     \\
%   Right bracket \]     Circumflex    \^     Underscore    \_
%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%   Right brace   \}     Tilde         \~}
%
%
% \changes{v1.0}{2015/10/09}{Initial version}
% \changes{v2.1}{2026/01/31}{Support for implicant naming, naming positions, arrows, and new environment options like label=braces and mintermnames.}
%
% \GetFileInfo{karnaugh-map.sty}
%
% \title{The \textsf{karnaugh-map} package}
% \author{Mattias Jacobsson}
% \date{\textsf{karnaugh-map}~\fileversion, \filedate}
%
%\maketitle
%
% \begin{abstract}
%   This package draws karnaugh maps with 2, 3, 4, 5, and 6 variables.
%   It also contains commands for filling the karnaugh map with terms semi-automatically or manually.
%   Last but not least it contains commands for drawing implicants on top of the map.
%   Below is an example of a two variable karnaugh map of $X_0 \oplus X_1$.
% \end{abstract}
% \begin{figure}[H]
%   \centering
%   \begin{karnaugh-map}[2][2][1]
%     \minterms{1,2}
%     \autoterms[0]
%     \implicant{1}{1}
%     \implicant{2}{2}
%   \end{karnaugh-map}
% \end{figure}
% \tableofcontents
% \pagebreak
%
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################

%%
%% Dependencies
%%

%% parsing arguments and options
\RequirePackage{kvoptions}
\RequirePackage{keyval}
\RequirePackage{xparse}

%% working with strings
\RequirePackage{xstring}

%% drawing
\RequirePackage{tikz}
\usetikzlibrary{calc,matrix,positioning,intersections,backgrounds,decorations.pathreplacing}

%% convert decimal to line style name
\newcommand{\@karnaughmap@func@decimaltolinestyle@}[1]{%
  \if@karnaughmap@option@linestyles
    \ifnum#1=0 LineStyleA\fi
    \ifnum#1=1 LineStyleB\fi
    \ifnum#1=2 LineStyleB\fi
    \ifnum#1=3 LineStyleC\fi
    \ifnum#1=4 LineStyleC\fi
    \ifnum#1=5 LineStyleD\fi
    \ifnum#1=6 LineStyleE\fi
    \ifnum#1>6 LineStyleF\fi
  \else
    solid%
  \fi
}

%% draw braces for variables
\newcommand{\@karnaughmap@func@drawbraces@}[2]{% #1=offsetx, #2=offsety
  % Columns
  \ifnum\@karnaughmap@var@mapsizex@=2
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (1+#1, -0.15+#2) --
      node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (2+#1, -0.15+#2);
  \fi
  \ifnum\@karnaughmap@var@mapsizex@=4
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (1+#1, -0.15+#2) --
      node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (3+#1, -0.15+#2);
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (2+#1, -0.45+#2) --
      node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelB@} (4+#1, -0.45+#2);
  \fi
  % Rows
  \ifnum\@karnaughmap@var@mapsizey@=2
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (\@karnaughmap@var@mapsizex@+0.15+#1, 0+#2) --
      node[right=0pt, font=\small, gray] {\ifnum\@karnaughmap@var@mapsizex@=4 \@karnaughmap@var@labelC@ \else \@karnaughmap@var@labelB@ \fi} (\@karnaughmap@var@mapsizex@+0.15+#1, 1+#2);
  \fi
  \ifnum\@karnaughmap@var@mapsizey@=4
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (\@karnaughmap@var@mapsizex@+0.15+#1, 1+#2) --
      node[right=0pt, font=\small, gray] {\@karnaughmap@var@labelC@} (\@karnaughmap@var@mapsizex@+0.15+#1, 3+#2);
    \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (\@karnaughmap@var@mapsizex@+0.45+#1, 0+#2) --
      node[right=0pt, font=\small, gray] {\@karnaughmap@var@labelD@} (\@karnaughmap@var@mapsizex@+0.45+#1, 2+#2);
  \fi
}

%% convert decimal to binary 6-bit
\newcommand{\@karnaughmap@func@decimaltobin@}[1]{%
  \ifnum#1=0 000000\fi
  \ifnum#1=1 000001\fi
  \ifnum#1=2 000010\fi
  \ifnum#1=3 000011\fi
  \ifnum#1=4 000100\fi
  \ifnum#1=5 000101\fi
  \ifnum#1=6 000110\fi
  \ifnum#1=7 000111\fi
  \ifnum#1=8 001000\fi
  \ifnum#1=9 001001\fi
  \ifnum#1=10 001010\fi
  \ifnum#1=11 001011\fi
  \ifnum#1=12 001100\fi
  \ifnum#1=13 001101\fi
  \ifnum#1=14 001110\fi
  \ifnum#1=15 001111\fi
  \ifnum#1=16 010000\fi
  \ifnum#1=17 010001\fi
  \ifnum#1=18 010010\fi
  \ifnum#1=19 010011\fi
  \ifnum#1=20 010100\fi
  \ifnum#1=21 010101\fi
  \ifnum#1=22 010110\fi
  \ifnum#1=23 010111\fi
  \ifnum#1=24 011000\fi
  \ifnum#1=25 011001\fi
  \ifnum#1=26 011010\fi
  \ifnum#1=27 011011\fi
  \ifnum#1=28 011100\fi
  \ifnum#1=29 011101\fi
  \ifnum#1=30 011110\fi
  \ifnum#1=31 011111\fi
  \ifnum#1=32 100000\fi
  \ifnum#1=33 100001\fi
  \ifnum#1=34 100010\fi
  \ifnum#1=35 100011\fi
  \ifnum#1=36 100100\fi
  \ifnum#1=37 100101\fi
  \ifnum#1=38 100110\fi
  \ifnum#1=39 100111\fi
  \ifnum#1=40 101000\fi
  \ifnum#1=41 101001\fi
  \ifnum#1=42 101010\fi
  \ifnum#1=43 101011\fi
  \ifnum#1=44 101100\fi
  \ifnum#1=45 101101\fi
  \ifnum#1=46 101110\fi
  \ifnum#1=47 101111\fi
  \ifnum#1=48 110000\fi
  \ifnum#1=49 110001\fi
  \ifnum#1=50 110010\fi
  \ifnum#1=51 110011\fi
  \ifnum#1=52 110100\fi
  \ifnum#1=53 110101\fi
  \ifnum#1=54 110110\fi
  \ifnum#1=55 110111\fi
  \ifnum#1=56 111000\fi
  \ifnum#1=57 111001\fi
  \ifnum#1=58 111010\fi
  \ifnum#1=59 111011\fi
  \ifnum#1=60 111100\fi
  \ifnum#1=61 111101\fi
  \ifnum#1=62 111110\fi
  \ifnum#1=63 111111\fi
}

%% command raises an error if executed outside the karnaugh-map environment
\newcommand{\@karnaughmap@func@bailoutsideenvironment@}[0]{%
  \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=000
    \PackageError{karnaugh-map}{%
      Command can not be used outside karnaugh-map environment%
    }{%
      Do not use this command outside the karnaugh-map environment.%
    }
  \fi
}

%% store map size
\newcommand{\@karnaughmap@var@mapsizex@}{0}
\newcommand{\@karnaughmap@var@mapsizey@}{0}
\newcommand{\@karnaughmap@var@mapsizez@}{0}

%% store map labels
\newcommand{\@karnaughmap@var@labelA@}{$X_0$}
\newcommand{\@karnaughmap@var@labelB@}{$X_1$}
\newcommand{\@karnaughmap@var@labelC@}{$X_2$}
\newcommand{\@karnaughmap@var@labelD@}{$X_3$}
\newcommand{\@karnaughmap@var@labelE@}{$X_4$}
\newcommand{\@karnaughmap@var@labelF@}{$X_5$}
\newcommand{\@karnaughmap@var@labelX@}{$X_1$$X_0$}
\newcommand{\@karnaughmap@var@labelY@}{$X_3$$X_2$}
\newcommand{\@karnaughmap@var@labelZ@}{$X_5$$X_4$}
%% if map labels are defined using API version unknown(0), v1(1) or v2(2)
\newcommand{\@karnaughmap@var@labeltype@}{0}

%% store colors
\newcommand{\@karnaughmap@var@colors@}{red,green,yellow,cyan,blue,magenta}
\newcommand{\@karnaughmap@var@color@}{}
\newcommand{\@karnaughmap@var@namecolor@}{}
\newcount\@karnaughmap@local@colorloop@\relax
\newcommand{\@karnaughmap@local@color@}{}
\newcommand{\@karnaughmap@local@colorcount@}{}
\newcommand{\@karnaughmap@local@colorlist@}{}
\newcount\@karnaughmap@local@colorlen@\relax
\newcommand{\@karnaughmap@local@colorlenstr@}{0}
\newcount\@karnaughmap@local@colorindexmod@\relax
\newcount\@karnaughmap@local@namecolorindexmod@\relax
\newcount\@karnaughmap@local@namecolorindex@\relax
\newcommand{\@karnaughmap@local@namecolorselect@}{}

%% debug helper to show resolved color
\newcommand{\@karnaughmap@func@debugcolor@}[1]{%
  \if@karnaughmap@option@debugcolors
    \node[anchor=north west, text=\@karnaughmap@var@color@] at (#1.north west)
      {\tiny \@karnaughmap@var@color@};%
  \fi
}

%% update implicant color (cycles through list)
\newcommand{\@karnaughmap@func@updatecolor@}[0]{%
  % select color or fall back to cyan
  \def\@karnaughmap@local@color@{cyan}%
  \def\@karnaughmap@local@namecolorselect@{cyan}%
  \let\@karnaughmap@local@colorlist@\@karnaughmap@var@colors@
  % normalize color list (strip surrounding braces and spaces)
  \IfBeginWith{\@karnaughmap@local@colorlist@}{\{}{%
    \StrGobbleLeft{\@karnaughmap@local@colorlist@}{1}[\@karnaughmap@local@colorlist@]
  }{}
  \IfEndWith{\@karnaughmap@local@colorlist@}{\}}{%
    \StrGobbleRight{\@karnaughmap@local@colorlist@}{1}[\@karnaughmap@local@colorlist@]
  }{}
  \StrSubstitute{\@karnaughmap@local@colorlist@}{, }{,}[\@karnaughmap@local@colorlist@]%
  % determine list length
  \renewcommand{\@karnaughmap@local@colorlenstr@}{0}%
  \StrCount{\@karnaughmap@local@colorlist@}{,}[\@karnaughmap@local@colorlenstr@]%
  \@karnaughmap@local@colorlen@=\@karnaughmap@local@colorlenstr@\relax
  \IfStrEq{\@karnaughmap@local@colorlist@}{}{}{%
    \advance\@karnaughmap@local@colorlen@ by 1\relax
  }%
  % wrap color index to list length
  \@karnaughmap@local@colorindexmod@=\@karnaughmap@var@colorindex@\relax
  \ifnum\@karnaughmap@local@colorlen@>0\relax
    \loop\ifnum\@karnaughmap@local@colorindexmod@>\numexpr\@karnaughmap@local@colorlen@-1\relax
      \advance\@karnaughmap@local@colorindexmod@ by -\@karnaughmap@local@colorlen@\relax
    \repeat
  \else
    \@karnaughmap@local@colorindexmod@=0\relax
  \fi
  \@karnaughmap@local@namecolorindexmod@=\@karnaughmap@local@colorindexmod@\relax
  \ifnum\@karnaughmap@local@colorlen@>0\relax
    \ifnum\@karnaughmap@local@namecolorindexmod@>\numexpr\@karnaughmap@local@colorlen@-1\relax
      \advance\@karnaughmap@local@namecolorindexmod@ by -\@karnaughmap@local@colorlen@\relax
    \fi
  \else
    \@karnaughmap@local@namecolorindexmod@=0\relax
  \fi
  \foreach \@karnaughmap@local@coloritem@ [count=\@karnaughmap@local@colorcount@ from 0] in \@karnaughmap@local@colorlist@ {%
    \IfStrEq{\@karnaughmap@local@coloritem@}{}{}{%
      \ifnum\@karnaughmap@local@colorcount@=\@karnaughmap@local@colorindexmod@\relax
        \xdef\@karnaughmap@local@color@{\@karnaughmap@local@coloritem@}%
      \fi
      \ifnum\@karnaughmap@local@colorcount@=\@karnaughmap@local@namecolorindexmod@\relax
        \xdef\@karnaughmap@local@namecolorselect@{\@karnaughmap@local@coloritem@}%
      \fi
    }%
  }%
  % fallback: if still cyan and list is non-empty, use first color
  \IfStrEq{\@karnaughmap@local@color@}{cyan}{%
    \IfSubStr{\@karnaughmap@local@colorlist@}{,}{%
      \StrBefore{\@karnaughmap@local@colorlist@}{,}[\@karnaughmap@local@color@]%
    }{%
      \xdef\@karnaughmap@local@color@{\@karnaughmap@local@colorlist@}%
    }%
  }{}%
  \IfStrEq{\@karnaughmap@local@namecolorselect@}{cyan}{%
    \IfSubStr{\@karnaughmap@local@colorlist@}{,}{%
      \StrBefore{\@karnaughmap@local@colorlist@}{,}[\@karnaughmap@local@namecolorselect@]%
    }{%
      \xdef\@karnaughmap@local@namecolorselect@{\@karnaughmap@local@colorlist@}%
    }%
  }{}%
  % apply selected color and advance index
  \renewcommand{\@karnaughmap@var@color@}{\@karnaughmap@local@color@}%
  \renewcommand{\@karnaughmap@var@namecolor@}{\@karnaughmap@local@namecolorselect@}%
  \global\advance\@karnaughmap@var@colorindex@ by 1\relax
}



%% declare package and environment options
%% package options
\SetupKeyvalOptions{
  family=@karnaughmap@option,
  prefix=@karnaughmap@option@,
}
\DeclareStringOption[middle]{label}[middle]
\DeclareStringOption[]{labelsep}[]
\DeclareStringOption[red,green,yellow,cyan,blue,magenta]{implicantcolors}
\DeclareBoolOption[false]{linestyles}
\DeclareBoolOption[false]{debugcolors}
\DeclareBoolOption[true]{mintermnames}
\ProcessKeyvalOptions*
%% environment options
\define@key{karnaugh-map}{label}[middle]{\renewcommand{\@karnaughmap@option@label}{#1}}
\define@key{karnaugh-map}{labelsep}[]{\renewcommand{\@karnaughmap@option@labelsep}{#1}}
\define@key{karnaugh-map}{implicantcolors}[red,green,yellow,cyan,blue,magenta]{\renewcommand{\@karnaughmap@option@implicantcolors}{#1}}
\define@key{karnaugh-map}{linestyles}[false]{\@karnaughmap@option@linestylestrue}
\define@key{karnaugh-map}{debugcolors}[true]{\@karnaughmap@option@debugcolorstrue}
\define@key{karnaugh-map}{mintermnames}[true]{\@karnaughmap@option@mintermnamestrue}

%% render in black and white or color default to '0'(false/color)
\newcommand{\@karnaughmap@var@bw@}{0}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
%
% \section{Usage}
%
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################

%%
%% Environment
%%

% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \begin{environment}{karnaugh-map}
%    \changes{v2.0}{2018/12/13}{API change: variable labels are now specified separately.}
%    The |karnaugh-map| environment is the base for this package, and everything related to this package happens inside an instances of this environment.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\begin{karnaugh-map}|} & \\
%      \small{\parg{options}}     & \small{See section \ref{sec:usage:options}. Default: ''''} \\
%      \small{\meta{*}}           & \small{One asterisk for black and white map including implicants, non for colorized} \\
%      \small{\oarg{X size}}      & \small{Number of X-axis cells. Default: ''4''} \\
%      \small{\oarg{Y size}}      & \small{Number of Y-axis cells. Default: ''4''} \\
%      \small{\oarg{Z size}}      & \small{Number of X$\times$Y submaps. Default: ''1''} \\
%      \small{\oarg{label A}}\footnotemark     & \small{Label for variable one ($X_0$).} \\
%      \small{\oarg{label B}}\footnotemark[\value{footnote}]     & \small{Label for variable two ($X_1$).} \\
%      \small{\oarg{label C}}\footnotemark[\value{footnote}]     & \small{Label for variable three ($X_2$).} \\
%      \small{\oarg{label D}}     & \small{Label for variable four ($X_3$).} \\
%      \small{\oarg{label E}}     & \small{Label for variable five ($X_4$).} \\
%      \small{\oarg{label F}}     & \small{Label for variable six ($X_5$).} \\
%    \end{tabularx}
%
%     \footnotetext{The arguments \oarg{label A}, \oarg{label B}, and \oarg{label C} are currently backward compatible with \oarg{X label}, \oarg{Y label}, and \oarg{Z label} in version v1's definition of the |karnaugh-map| environment. This works through a heuristic method. However the v1 definition is now deprecated and this backward compatibility may disappear in a later version.}
%
%    \textbf{Example:}
%
%    Four variable karnaugh map, colorized, with X label $X_1X_0$, and Y label $X_3X_2$.
%    \begin{verbatim}
%\begin{karnaugh-map}
%\end{karnaugh-map}
%
%or
%
%\begin{karnaugh-map}[4][4][1][$X_0$][$X_1$][$X_2$][$X_3$]
%\end{karnaugh-map}
%    \end{verbatim}
%    Six variable karnaugh map, black and white, with X label $ba$, Y label $dc$, and Z label $fe$.
%    \begin{verbatim}
%\begin{karnaugh-map}*[4][4][4][$a$][$b$][$c$][$d$][$e$][$f$]
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\NewDocumentEnvironment{karnaugh-map}{D(){} s O{4} O{4} O{1}} {%
  \begingroup\tracinglostchars=0\relax
    % parse environment options
    \setkeys{karnaugh-map}{#1}%
    %
    % check if implicant colors are specified
    \IfStrEq{\@karnaughmap@option@implicantcolors}{}{}{%
      \newcommand{\@karnaughmap@local@colorsopt@}{}%
      \renewcommand{\@karnaughmap@local@colorsopt@}{\@karnaughmap@option@implicantcolors}%
      % strip surrounding braces if present
      \IfBeginWith{\@karnaughmap@local@colorsopt@}{\{}{
        \StrGobbleLeft{\@karnaughmap@local@colorsopt@}{1}[\@karnaughmap@local@colorsopt@]
      }{}
      \IfEndWith{\@karnaughmap@local@colorsopt@}{\}}{
        \StrGobbleRight{\@karnaughmap@local@colorsopt@}{1}[\@karnaughmap@local@colorsopt@]
      }{}
      % remove spaces after commas
      \StrSubstitute{\@karnaughmap@local@colorsopt@}{, }{,}[\@karnaughmap@local@colorsopt@]%
      % ensure no empty colors are specified
      \IfSubStr{\@karnaughmap@local@colorsopt@}{,,}{%
        \PackageError{karnaugh-map}{%
          Incorrect usage of option implicantcolors%
        }{%
          The option implicantcolors is a comma separated list of colors with no gap. You used two consecutive commas.%
        }%
      }{}%
      % remove duplicate commas (if any) and store
      \StrSubstitute{\@karnaughmap@local@colorsopt@}{,,}{,}[\@karnaughmap@var@colors@]%
    }%
    % reset implicant color index per map
    \global\@karnaughmap@var@colorindex@=0\relax
    \global\@karnaughmap@var@colorindexnext@=1\relax
    \renewcommand{\@karnaughmap@var@color@}{}%
    \renewcommand{\@karnaughmap@var@namecolor@}{}%
    % reset used cells per map
    \renewcommand{\@karnaughmap@var@usedcells@}{,}%
    %
    % determinate if markings should be color or black and white
    \IfBooleanTF{#2}{%
      % should be black and white
      \renewcommand{\@karnaughmap@var@bw@}{1}%
    }{%
      % should be color
      \renewcommand{\@karnaughmap@var@bw@}{0}%
    }%
    %
    % store map size {[START]
      \renewcommand{\@karnaughmap@var@mapsizex@}{#3}%
      \renewcommand{\@karnaughmap@var@mapsizey@}{#4}%
      \renewcommand{\@karnaughmap@var@mapsizez@}{#5}%
    % [END]}
    %
    % only 9 arguments are directly supported. jump to helper function
    % to parse remaining arguments and finish initialization.
    \@karnaughmap@func@karnaughstart@%
}{
    \end{tikzpicture}
  \endgroup
}
\DeclareDocumentCommand{\@karnaughmap@func@karnaughstart@}{oooooo} {%
  % parse label args {[START]
    % try to maintain backwards compatibility with v1 while enabling users to separatly
    % specify each input label variable
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=221
      % no difference
      \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
      \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
      \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelA@}%
      \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelB@}%
      \renewcommand{\@karnaughmap@var@labeltype@}{2}%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=241
      \IfValueT{#1}{\IfValueT{#2}{\IfValueF{#3}{%
        % API v1
        \renewcommand{\@karnaughmap@var@labelX@}{#1}%
        \renewcommand{\@karnaughmap@var@labelY@}{#2}%
        \renewcommand{\@karnaughmap@var@labeltype@}{1}%
      }}}%
      \ifnum\@karnaughmap@var@labeltype@=0
        % API v2
        \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
        \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
        \IfValueT{#3}{\renewcommand{\@karnaughmap@var@labelC@}{#3}}%
        \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelA@}%
        \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelC@\@karnaughmap@option@labelsep\@karnaughmap@var@labelB@}%
        \renewcommand{\@karnaughmap@var@labeltype@}{2}%
      \fi
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=421
      \IfValueT{#1}{\IfValueT{#2}{\IfValueF{#3}{%
        % API v1
        \renewcommand{\@karnaughmap@var@labelX@}{#1}%
        \renewcommand{\@karnaughmap@var@labelY@}{#2}%
        \renewcommand{\@karnaughmap@var@labeltype@}{1}%
      }}}%
      \ifnum\@karnaughmap@var@labeltype@=0
        % API v2
        \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
        \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
        \IfValueT{#3}{\renewcommand{\@karnaughmap@var@labelC@}{#3}}%
        \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelB@\@karnaughmap@option@labelsep\@karnaughmap@var@labelA@}%
        \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelC@}%
        \renewcommand{\@karnaughmap@var@labeltype@}{2}%
      \fi
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=441
      \IfValueT{#1}{\IfValueT{#2}{\IfValueF{#3}{%
        % API v1
        \renewcommand{\@karnaughmap@var@labelX@}{#1}%
        \renewcommand{\@karnaughmap@var@labelY@}{#2}%
        \renewcommand{\@karnaughmap@var@labeltype@}{1}%
      }}}%
      \ifnum\@karnaughmap@var@labeltype@=0
        % API v2
        \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
        \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
        \IfValueT{#3}{\renewcommand{\@karnaughmap@var@labelC@}{#3}}%
        \IfValueT{#4}{\renewcommand{\@karnaughmap@var@labelD@}{#4}}%
        \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelB@\@karnaughmap@option@labelsep\@karnaughmap@var@labelA@}%
        \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelD@\@karnaughmap@option@labelsep\@karnaughmap@var@labelC@}%
        \renewcommand{\@karnaughmap@var@labeltype@}{2}%
      \fi
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=442
      \IfValueT{#1}{\IfValueT{#2}{\IfValueT{#3}{\IfValueF{#4}{%
        % API v1
        \renewcommand{\@karnaughmap@var@labelX@}{#1}%
        \renewcommand{\@karnaughmap@var@labelY@}{#2}%
        \renewcommand{\@karnaughmap@var@labelZ@}{#3}%
        \renewcommand{\@karnaughmap@var@labeltype@}{1}%
      }}}}%
      \ifnum\@karnaughmap@var@labeltype@=0
        % API v2
        \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
        \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
        \IfValueT{#3}{\renewcommand{\@karnaughmap@var@labelC@}{#3}}%
        \IfValueT{#4}{\renewcommand{\@karnaughmap@var@labelD@}{#4}}%
        \IfValueT{#5}{\renewcommand{\@karnaughmap@var@labelE@}{#5}}%
        \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelB@\@karnaughmap@option@labelsep\@karnaughmap@var@labelA@}%
        \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelD@\@karnaughmap@option@labelsep\@karnaughmap@var@labelC@}%
        \renewcommand{\@karnaughmap@var@labelZ@}{\@karnaughmap@var@labelE@}%
        \renewcommand{\@karnaughmap@var@labeltype@}{2}%
      \fi
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=444
      \IfValueT{#1}{\IfValueT{#2}{\IfValueT{#3}{\IfValueF{#4}{%
        % API v1
        \renewcommand{\@karnaughmap@var@labelX@}{#1}%
        \renewcommand{\@karnaughmap@var@labelY@}{#2}%
        \renewcommand{\@karnaughmap@var@labelZ@}{#3}%
        \renewcommand{\@karnaughmap@var@labeltype@}{1}%
      }}}}%
      \ifnum\@karnaughmap@var@labeltype@=0
        % API v2
        \IfValueT{#1}{\renewcommand{\@karnaughmap@var@labelA@}{#1}}%
        \IfValueT{#2}{\renewcommand{\@karnaughmap@var@labelB@}{#2}}%
        \IfValueT{#3}{\renewcommand{\@karnaughmap@var@labelC@}{#3}}%
        \IfValueT{#4}{\renewcommand{\@karnaughmap@var@labelD@}{#4}}%
        \IfValueT{#5}{\renewcommand{\@karnaughmap@var@labelE@}{#5}}%
        \IfValueT{#6}{\renewcommand{\@karnaughmap@var@labelF@}{#6}}%
        \renewcommand{\@karnaughmap@var@labelX@}{\@karnaughmap@var@labelB@\@karnaughmap@option@labelsep\@karnaughmap@var@labelA@}%
        \renewcommand{\@karnaughmap@var@labelY@}{\@karnaughmap@var@labelD@\@karnaughmap@option@labelsep\@karnaughmap@var@labelC@}%
        \renewcommand{\@karnaughmap@var@labelZ@}{\@karnaughmap@var@labelF@\@karnaughmap@option@labelsep\@karnaughmap@var@labelE@}%
        \renewcommand{\@karnaughmap@var@labeltype@}{2}%
      \fi
    \fi
    % warn when using API v1
    \ifnum\@karnaughmap@var@labeltype@=1
      \PackageWarning{karnaugh-map}{%
        The API for specifying variable labels have been updated. You are currently using the old API(v1).
        In the new API each variable label is specified separately. See the documentation for more details.
        Backward compatibility may disappear in a future release.%
      }%
    \fi
  % [END]}
  %
  % find matching matrix template and alignment parameters {[START]
    \newcommand{\@karnaughmap@local@matrixtemplate@}{0}% '0' is considered as missing matrix template
    \newcommand{\@karnaughmap@local@maprealignmentx@}{0}%
    \newcommand{\@karnaughmap@local@maprealignmenty@}{0}%
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=221
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                       0 \&                       1 \& \phantom{0} \\
                   0 \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \&             \\
                   1 \& |(000010)|  \phantom{0} \& |(000011)|  \phantom{0} \&             \\
        \phantom{0}  \&                         \&                         \&             \\
      }%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=241
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                       0 \&                       1 \& \phantom{00} \\
                  00 \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \&              \\
                  01 \& |(000010)|  \phantom{0} \& |(000011)|  \phantom{0} \&              \\
                  11 \& |(000110)|  \phantom{0} \& |(000111)|  \phantom{0} \&              \\
                  10 \& |(000100)|  \phantom{0} \& |(000101)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&              \\
      }%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=421
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \\
                  0  \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \& |(000011)|  \phantom{0} \& |(000010)|  \phantom{0} \&              \\
                  1  \& |(000100)|  \phantom{0} \& |(000101)|  \phantom{0} \& |(000111)|  \phantom{0} \& |(000110)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&                         \&                         \&              \\
      }%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=441
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \\
                  00 \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \& |(000011)|  \phantom{0} \& |(000010)|  \phantom{0} \&              \\
                  01 \& |(000100)|  \phantom{0} \& |(000101)|  \phantom{0} \& |(000111)|  \phantom{0} \& |(000110)|  \phantom{0} \&              \\
                  11 \& |(001100)|  \phantom{0} \& |(001101)|  \phantom{0} \& |(001111)|  \phantom{0} \& |(001110)|  \phantom{0} \&              \\
                  10 \& |(001000)|  \phantom{0} \& |(001001)|  \phantom{0} \& |(001011)|  \phantom{0} \& |(001010)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&                         \&                         \&              \\
      }%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=442
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \\
                  00 \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \& |(000011)|  \phantom{0} \& |(000010)|  \phantom{0} \&              \& |(010000)|  \phantom{0} \& |(010001)|  \phantom{0} \& |(010011)|  \phantom{0} \& |(010010)|  \phantom{0} \&              \\
                  01 \& |(000100)|  \phantom{0} \& |(000101)|  \phantom{0} \& |(000111)|  \phantom{0} \& |(000110)|  \phantom{0} \&              \& |(010100)|  \phantom{0} \& |(010101)|  \phantom{0} \& |(010111)|  \phantom{0} \& |(010110)|  \phantom{0} \&              \\
                  11 \& |(001100)|  \phantom{0} \& |(001101)|  \phantom{0} \& |(001111)|  \phantom{0} \& |(001110)|  \phantom{0} \&              \& |(011100)|  \phantom{0} \& |(011101)|  \phantom{0} \& |(011111)|  \phantom{0} \& |(011110)|  \phantom{0} \&              \\
                  10 \& |(001000)|  \phantom{0} \& |(001001)|  \phantom{0} \& |(001011)|  \phantom{0} \& |(001010)|  \phantom{0} \&              \& |(011000)|  \phantom{0} \& |(011001)|  \phantom{0} \& |(011011)|  \phantom{0} \& |(011010)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&                         \&                         \&              \&                         \&                         \&                         \&                         \&              \\
      }%
      \renewcommand{\@karnaughmap@local@maprealignmentx@}{2.5}%
    \fi
    \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@\@karnaughmap@var@mapsizez@=444
      \renewcommand{\@karnaughmap@local@matrixtemplate@}{%
                     \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \&                      00 \&                      01 \&                      11 \&                      10 \& \phantom{00} \\
                  00 \& |(000000)|  \phantom{0} \& |(000001)|  \phantom{0} \& |(000011)|  \phantom{0} \& |(000010)|  \phantom{0} \&              \& |(010000)|  \phantom{0} \& |(010001)|  \phantom{0} \& |(010011)|  \phantom{0} \& |(010010)|  \phantom{0} \&              \\
                  01 \& |(000100)|  \phantom{0} \& |(000101)|  \phantom{0} \& |(000111)|  \phantom{0} \& |(000110)|  \phantom{0} \&              \& |(010100)|  \phantom{0} \& |(010101)|  \phantom{0} \& |(010111)|  \phantom{0} \& |(010110)|  \phantom{0} \&              \\
                  11 \& |(001100)|  \phantom{0} \& |(001101)|  \phantom{0} \& |(001111)|  \phantom{0} \& |(001110)|  \phantom{0} \&              \& |(011100)|  \phantom{0} \& |(011101)|  \phantom{0} \& |(011111)|  \phantom{0} \& |(011110)|  \phantom{0} \&              \\
                  10 \& |(001000)|  \phantom{0} \& |(001001)|  \phantom{0} \& |(001011)|  \phantom{0} \& |(001010)|  \phantom{0} \&              \& |(011000)|  \phantom{0} \& |(011001)|  \phantom{0} \& |(011011)|  \phantom{0} \& |(011010)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&                         \&                         \&              \&                         \&                         \&                         \&                         \&              \\
                  00 \& |(100000)|  \phantom{0} \& |(100001)|  \phantom{0} \& |(100011)|  \phantom{0} \& |(100010)|  \phantom{0} \&              \& |(110000)|  \phantom{0} \& |(110001)|  \phantom{0} \& |(110011)|  \phantom{0} \& |(110010)|  \phantom{0} \&              \\
                  01 \& |(100100)|  \phantom{0} \& |(100101)|  \phantom{0} \& |(100111)|  \phantom{0} \& |(100110)|  \phantom{0} \&              \& |(110100)|  \phantom{0} \& |(110101)|  \phantom{0} \& |(110111)|  \phantom{0} \& |(110110)|  \phantom{0} \&              \\
                  11 \& |(101100)|  \phantom{0} \& |(101101)|  \phantom{0} \& |(101111)|  \phantom{0} \& |(101110)|  \phantom{0} \&              \& |(111100)|  \phantom{0} \& |(111101)|  \phantom{0} \& |(111111)|  \phantom{0} \& |(111110)|  \phantom{0} \&              \\
                  10 \& |(101000)|  \phantom{0} \& |(101001)|  \phantom{0} \& |(101011)|  \phantom{0} \& |(101010)|  \phantom{0} \&              \& |(111000)|  \phantom{0} \& |(111001)|  \phantom{0} \& |(111011)|  \phantom{0} \& |(111010)|  \phantom{0} \&              \\
        \phantom{00} \&                         \&                         \&                         \&                         \&              \&                         \&                         \&                         \&                         \&              \\
      }%
      \renewcommand{\@karnaughmap@local@maprealignmentx@}{2.5}%
      \renewcommand{\@karnaughmap@local@maprealignmenty@}{-2.5}%
    \fi
  % [END]}
  % test if a matrix template is found or not(aka "\@karnaughmap@local@matrixtemplate@" equals to '0')
  \ifnum0=\@karnaughmap@local@matrixtemplate@
    % print error if no template could be found
    \PackageError{karnaugh-map}{%
      Can not find a template fitting your specification (\@karnaughmap@var@mapsizex@\space x \@karnaughmap@var@mapsizey@\space x \@karnaughmap@var@mapsizez@)%
    }{%
      Existing templates have the following dimensions: 2x2x1, 2x4x1, 4x2x1, 4x4x1, 4x4x2, and 4x4x4.
    }%
  \fi
  \pgfdeclarelayer{foreground}
  \pgfsetlayers{background,main,foreground}
  \begin{tikzpicture}[
    LineStyleA/.style={semithick,solid},
    LineStyleB/.style={semithick,dash dot dot},
    LineStyleC/.style={thin,double distance=0.8pt},
    LineStyleD/.style={ultra thick},
    LineStyleE/.style={semithick,dashed},
    LineStyleF/.style={semithick,densely dotted},
  ]
    % grid {[START]
      % for all dimensions
      \draw[color=black, ultra thin] (0,0) grid (\@karnaughmap@var@mapsizex@,\@karnaughmap@var@mapsizey@);
      % when there are 2 sub maps
      \ifnum\@karnaughmap@var@mapsizez@=2
        \draw[color=black, ultra thin] (5,0) grid (9,4);
      \fi
      % when there are 4 sub maps
      \ifnum\@karnaughmap@var@mapsizez@=4
        \draw[color=black, ultra thin] (5,0) grid (9,4);
        \draw[color=black, ultra thin] (0,-5) grid (4,-1);
        \draw[color=black, ultra thin] (5,-5) grid (9,-1);
      \fi
    % [END]}
    % labels {[START]
      \IfStrEq{\@karnaughmap@option@label}{corner}{%
        % if variables should be positioned at the corner
        %
        % for all dimensions
        \draw[color=black, ultra thin] (0,\@karnaughmap@var@mapsizey@) --
          node[pos=0.5, above right, anchor=south, rotate=-45] {\small{\@karnaughmap@var@labelX@}}
          node[pos=0.5, below left, anchor=north, rotate=-45] {\small{\@karnaughmap@var@labelY@}}
          ++(135:1);
        % when there are 2 sub maps
        \ifnum\@karnaughmap@var@mapsizez@=2
          % extra sub map labels
          \node[below] at (2,-0.1) {\small{\@karnaughmap@var@labelZ@$=0$}};
          \node[below] at (7,-0.1) {\small{\@karnaughmap@var@labelZ@$=1$}};
        \fi
        % when there are 4 sub maps
        \ifnum\@karnaughmap@var@mapsizez@=4
          % extra sub map labels
          \node[below] at (2,-0.1) {\small{\@karnaughmap@var@labelZ@$=00$}};
          \node[below] at (7,-0.1) {\small{\@karnaughmap@var@labelZ@$=01$}};
          \node[below] at (2,-5.1) {\small{\@karnaughmap@var@labelZ@$=10$}};
          \node[below] at (7,-5.1) {\small{\@karnaughmap@var@labelZ@$=11$}};
        \fi
      }{%
        \IfStrEq{\@karnaughmap@option@label}{braces}{%
          % if variables should be positioned using curly braces
          \draw[color=black, ultra thin] (0,\@karnaughmap@var@mapsizey@) --
            node[pos=0.5, above right, anchor=south, rotate=-45] {\small{\@karnaughmap@var@labelX@}}
            node[pos=0.5, below left, anchor=north, rotate=-45] {\small{\@karnaughmap@var@labelY@}}
            ++(135:1);
          \@karnaughmap@func@drawbraces@{\@karnaughmap@local@maprealignmentx@}{\@karnaughmap@local@maprealignmenty@}
          % when there are 2 sub maps
          \ifnum\@karnaughmap@var@mapsizez@=2
            % only top braces are repeated for 442
            \ifnum\@karnaughmap@var@mapsizex@=4
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (6, -0.15) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (8, -0.15);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (7, -0.45) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelB@} (9, -0.45);
            \fi
            % extra sub map labels
            \node[above, gray] at (2,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=0$}};
            \node[above, gray] at (7,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=1$}};
          \fi
          % when there are 4 sub maps
          \ifnum\@karnaughmap@var@mapsizez@=4
             \ifnum\@karnaughmap@var@mapsizex@=4
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (6, -0.15) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (8, -0.15);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (7, -0.45) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelB@} (9, -0.45);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (1, -5-0.15) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (3, -5-0.15);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (2, -5-0.45) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelB@} (4, -5-0.45);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (6, -5-0.15) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelA@} (8, -5-0.15);
              \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (7, -5-0.45) -- 
                node[below=0pt, font=\small, gray] {\@karnaughmap@var@labelB@} (9, -5-0.45);
            \fi
            % row braces for Map 10 and 11
            \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (9.15, -4) -- 
              node[right=0pt, font=\small, gray] {\@karnaughmap@var@labelC@} (9.15, -2);
            \draw[decoration={brace,amplitude=2.5pt,mirror},decorate,thick,gray] (9.45, -5) -- 
              node[right=0pt, font=\small, gray] {\@karnaughmap@var@labelD@} (9.45, -3);
            % extra sub map labels
            \node[above, gray] at (2,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=00$}};
            \node[above, gray] at (7,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=01$}};
            \node[above, gray] at (2,-0.9) {\small{\@karnaughmap@var@labelZ@$=10$}};
            \node[above, gray] at (7,-0.9) {\small{\@karnaughmap@var@labelZ@$=11$}};
          \fi
        }{%
          % if variables should be positioned in the middle(top and side). Default.
          %
          % for all dimensions
          \node[below, gray] at (\@karnaughmap@var@mapsizex@*0.5,-0.9) {\small{\@karnaughmap@var@labelX@}};
          \node[right, gray] at (\@karnaughmap@var@mapsizex@+0.9,\@karnaughmap@var@mapsizey@*0.5) {\small{\@karnaughmap@var@labelY@}};
          % when there are 2 sub maps
          \ifnum\@karnaughmap@var@mapsizez@=2
            \node[below, gray] at (7,-0.9) {\small{\@karnaughmap@var@labelX@}};
            % extra sub map labels
            \node[above, gray] at (2,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=0$}};
            \node[above, gray] at (7,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=1$}};
          \fi
          % when there are 4 sub maps
          \ifnum\@karnaughmap@var@mapsizez@=4
            \node[below, gray] at (7,-0.9) {\small{\@karnaughmap@var@labelX@}};
            \node[right, gray] at (9.9,-3) {\small{\@karnaughmap@var@labelY@}};
            % extra sub map labels
            \node[above, gray] at (2,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=00$}};
            \node[above, gray] at (7,\@karnaughmap@var@mapsizey@+0.1) {\small{\@karnaughmap@var@labelZ@$=01$}};
            \node[above, gray] at (2,-0.9) {\small{\@karnaughmap@var@labelZ@$=10$}};
            \node[above, gray] at (7,-0.9) {\small{\@karnaughmap@var@labelZ@$=11$}};
          \fi
        }%
      }
    % [END]}
    % data
    \matrix[
      matrix of nodes,
      ampersand replacement=\&,
      column sep={1cm,between origins},
      row sep={1cm,between origins},
    ] at (\@karnaughmap@var@mapsizex@*0.5+\@karnaughmap@local@maprealignmentx@,\@karnaughmap@var@mapsizey@*0.5+\@karnaughmap@local@maprealignmenty@) {
      \@karnaughmap@local@matrixtemplate@%
    };
    % minterm names (tiny, bottom-right of each cell)
    \if@karnaughmap@option@mintermnames
      \begingroup
        \newcount\@karnaughmap@local@mintermmax@\relax
        \@karnaughmap@local@mintermmax@=\@karnaughmap@var@mapsizex@\relax
        \multiply\@karnaughmap@local@mintermmax@ by \@karnaughmap@var@mapsizey@\relax
        \multiply\@karnaughmap@local@mintermmax@ by \@karnaughmap@var@mapsizez@\relax
        \advance\@karnaughmap@local@mintermmax@ by -1\relax
        \begin{scope}[on background layer]
          \foreach \cell in {0,1,2,...,\the\@karnaughmap@local@mintermmax@} {%
            \node[anchor=south east, inner sep=0pt, text=gray] at
              ($ (\@karnaughmap@func@decimaltobin@{\cell}.center)+(0.48,-0.48) $)
              {\tiny $m_{\cell}$};
          }%
        \end{scope}
      \endgroup
    \fi
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{environment}
%
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################

%%
%% Commands for filling out the cells
%%

%% store already used cells to avoid double filled cells and for auto completion
\newcommand{\@karnaughmap@var@usedcells@}{,}

% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
%
% \newpage
% \subsection{Terms}
% \begin{macro}{\autoterms}
%    The |\autoterms| command fills the remaining unfilled cells of the karnaugh map with the contents of the optional argument.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\autoterms|}   & \\
%      \small{\oarg{content}} & \small{Content for the remaining unfilled cells. Default: ''-''}
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill all remaining unfilled cells with ''-''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \autoterms[-]
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\newcount\@karnaughmap@local@max@\relax
\DeclareDocumentCommand{\autoterms}{O{-}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \def\@karnaughmap@local@autotermscontent@{#1}%
  % calculate max cell number {[START]
    \@karnaughmap@local@max@=\@karnaughmap@var@mapsizex@\relax
    \multiply\@karnaughmap@local@max@ by \@karnaughmap@var@mapsizey@\relax
    \multiply\@karnaughmap@local@max@ by \@karnaughmap@var@mapsizez@\relax
    \advance\@karnaughmap@local@max@ by -1\relax
  % [END]}
  % fill terms
  \begin{pgfonlayer}{foreground}
    \foreach \cell in {0,1,2,...,\@karnaughmap@local@max@} {%
      % only write to cell if it is empty otherwise fail silently
      \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
        \node[text=black] at (\@karnaughmap@func@decimaltobin@{\cell}) {\@karnaughmap@local@autotermscontent@};
        % update \@karnaughmap@var@usedcells@ (per-map scope)
        \expandafter\def\expandafter\@karnaughmap@var@usedcells@\expandafter{\@karnaughmap@var@usedcells@\cell,}%
      }%
    }%
  \end{pgfonlayer}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \begin{macro}{\indeterminants}
%    The |\indeterminants| command fills the specified cells with ''-'' if they aren't already filled. Order of the cell numbers does not matter.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\indeterminants|} & \\
%      \small{\marg{cells}}   & \small{Comma separated list of cells to fill with ''-''}
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the top left and right cell with ''-''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \indeterminants{0,2}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\DeclareDocumentCommand{\indeterminants}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{-}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \begin{macro}{\manualterms}
%    The |\manualterms| command fills the 0th cell with the first element in the argument, the 1st cell with the second element in the argument, and so on. If any of the cells already is filled, it is left as it was.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\manualterms|} & \\
%      \small{\marg{content}} & \small{Comma separated list of cell contents}
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the first four cells with 0, 1, 0, and 1 respectively.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \manualterms{0,1,0,1}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\newcount\@karnaughmap@local@cellcount@\relax
\DeclareDocumentCommand{\manualterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \foreach \cellinfo [count=\cell from 0] in {#1} {%
    % only write to cell if it is empty otherwise fail silently
    \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
      \path (\@karnaughmap@func@decimaltobin@{\cell}) node {\cellinfo};
    }
  }
  % update \@karnaughmap@var@usedcells@ (previous cells + all cells up to \@karnaughmap@local@cellcount@ are used now) {[START]
    \newcommand{\@karnaughmap@local@tmpusedcells@}{}
    % count number of cells in #1 {[START]
      \StrCount{#1}{,}[\@karnaughmap@local@tmpusedcells@]
      \@karnaughmap@local@cellcount@=\@karnaughmap@local@tmpusedcells@\relax
      \advance\@karnaughmap@local@cellcount@ by 1\relax
      \multiply\@karnaughmap@local@cellcount@ by 2\relax
    % [END]}
    % create sequence for \@karnaughmap@local@tmpusedcells@
    \StrLeft{0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,}{\@karnaughmap@local@cellcount@}[\@karnaughmap@local@tmpusedcells@]
    % update \@karnaughmap@var@usedcells@ (append \@karnaughmap@local@tmpusedcells@)
    \expandafter\def\expandafter\@karnaughmap@var@usedcells@\expandafter{\@karnaughmap@var@usedcells@\@karnaughmap@local@tmpusedcells@}
  % [END]}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \newpage
% \begin{macro}{\maxterms}
%    The |\maxterms| command fills the specified cells with ''0'' if they aren't already filled. Order of the cell numbers does not matter.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\maxterms|}  & \\
%      \small{\marg{cells}} & \small{Comma separated list of cells to fill with ''0''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the top left and right cell with ''0''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \maxterms{0,2}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\DeclareDocumentCommand{\maxterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{0}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \begin{macro}{\minterms}
%    The |\minterms| command fills the specified cells with ''1'' if they aren't already filled. Order of the cell numbers does not matter.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\minterms|}  & \\
%      \small{\marg{cells}} & \small{Comma separated list of cells to fill with ''1''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the top left and right cell with ''1''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \minterms{0,2}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\DeclareDocumentCommand{\minterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{1}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \begin{macro}{\donotcareterms}
%    The |\donotcareterms| command fills the specified cells with ''x'' if they aren't already filled. Order of the cell numbers does not matter.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\donotcareterms|}  & \\
%      \small{\marg{cells}} & \small{Comma separated list of cells to fill with ''x''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the top left and right cell with ''x''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \donotcareterms{0,2}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\DeclareDocumentCommand{\donotcareterms}{m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \terms{#1}{\small x}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \begin{macro}{\terms}
%    \changes{v1.1}{2017/02/06}{Support user specified term content and variable entered maps}
%    The |\terms| command fills the specified cells with the specified content if they aren't already filled. Order of the cell numbers does not matter.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\terms|}  & \\
%      \small{\marg{cells}} & \small{Comma separated list of cells to fill with content} \\
%      \small{\marg{content}} & \small{Content to fill the cells with} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    Fill the top left and right cell with ''X''.
%    \begin{verbatim}
%\begin{karnaugh-map}
%  \terms{0,2}{X}
%\end{karnaugh-map}
%    \end{verbatim}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\DeclareDocumentCommand{\terms}{m m} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  \foreach \cell in {#1} {%
    % only write to cell if it is empty otherwise fail silently
    \IfSubStr{\@karnaughmap@var@usedcells@}{,\cell,}{}{%
      \path (\@karnaughmap@func@decimaltobin@{\cell}) node {#2};
    }
  }
  % update \@karnaughmap@var@usedcells@
  \expandafter\def\expandafter\@karnaughmap@var@usedcells@\expandafter{\@karnaughmap@var@usedcells@#1,}
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################

%%
%% Commands for marking the cells
%%

%% keep track of used colors
\newcount\@karnaughmap@var@colorindex@\relax
\newcount\@karnaughmap@var@colorindexnext@\relax
\@karnaughmap@var@colorindex@=0\relax
\@karnaughmap@var@colorindexnext@=1\relax

%% implicant name options (local per implicant command)
\newcommand{\@karnaughmap@var@implicantname@}{}
%% style applied inside the node content (e.g. \scriptsize, \tiny\bfseries)
\newcommand{\@karnaughmap@var@implicantnamestyle@}{\scriptsize}
%% where to place the name: 'center' (default), 'below', or 'outside'
\newcommand{\@karnaughmap@var@implicantnamepos@}{center}
%% per-implicant color overrides
\newcommand{\@karnaughmap@var@implicantcolor@}{}
\newcommand{\@karnaughmap@var@implicantnamecolor@}{}
%% outside label placement controls
\newcommand{\@karnaughmap@var@implicantnamegap@}{1mm}
\newcommand{\@karnaughmap@var@implicantnameangle@}{90}
\newcommand{\@karnaughmap@var@implicantnamedistance@}{10mm}
\newcommand{\@karnaughmap@var@implicantnamearrowstyle@}{->}
\define@key{karnaugh-map-implicant}{name}{\renewcommand{\@karnaughmap@var@implicantname@}{#1}}
\define@key{karnaugh-map-implicant}{namestyle}{\renewcommand{\@karnaughmap@var@implicantnamestyle@}{#1}}
\define@key{karnaugh-map-implicant}{namepos}{\renewcommand{\@karnaughmap@var@implicantnamepos@}{#1}}
\define@key{karnaugh-map-implicant}{color}{\renewcommand{\@karnaughmap@var@implicantcolor@}{#1}}
\define@key{karnaugh-map-implicant}{namecolor}{\renewcommand{\@karnaughmap@var@implicantnamecolor@}{#1}}
\define@key{karnaugh-map-implicant}{namegap}{\renewcommand{\@karnaughmap@var@implicantnamegap@}{#1}}
\define@key{karnaugh-map-implicant}{nameangle}{\renewcommand{\@karnaughmap@var@implicantnameangle@}{#1}}
\define@key{karnaugh-map-implicant}{namedistance}{\renewcommand{\@karnaughmap@var@implicantnamedistance@}{#1}}
\define@key{karnaugh-map-implicant}{namearrowstyle}{\renewcommand{\@karnaughmap@var@implicantnamearrowstyle@}{#1}}

%% label placement helpers (allocated once)
\newcount\@karnaughmap@local@labela@\relax
\newcount\@karnaughmap@local@labelb@\relax
\newcount\@karnaughmap@local@labelc@\relax
\newcount\@karnaughmap@local@labeld@\relax
\newcount\@karnaughmap@local@centerone@\relax
\newcount\@karnaughmap@local@centertwo@\relax
\newcount\@karnaughmap@local@target@\relax

% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
%
% \newpage
% \subsection{Implicants}
% \begin{macro}{\implicant}
%    The |\implicant| command draws quadratic implicants on one or multiple submaps. If the implicant shall be drawn on multiple submaps, \marg{northwest cell} and \marg{southeast cell} must be specified as if the implicant was to be drawn on the 0:th submap. When turned on, colorization is done automatically, following a global sequence of available colors.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\implicant|}          & \\
%      \small{\parg{options}}        & \small{See section \ref{sec:usage:options:implicant}. Default: ''''} \\
%      \small{\marg{northwest cell}} & \small{The most northwest cell in the implicant} \\
%      \small{\marg{southeast cell}} & \small{The most southeast cell in the implicant} \\
%      \small{\oarg{submaps}}        & \small{Comma separated list of submaps the implicant should be drawn on. Default: ''0''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    \begin{multicols}{2}
%      [Implicant around the four most inner cells.]
%      \begin{verbatim}
%\begin{karnaugh-map}
%  \implicant{5}{15}
%\end{karnaugh-map}
%      \end{verbatim}
%      \columnbreak
%      \resizebox{\columnwidth}{!}{%
%        \begin{karnaugh-map}
%          \implicant{5}{15}
%        \end{karnaugh-map}%
%      }
%    \end{multicols}
%    \begin{multicols}{2}
%      [Single cell implicant, 0:th cell, on all four submaps.]
%      \begin{verbatim}
%\begin{karnaugh-map}[4][4][4]
%  \implicant{0}{0}[0,1,2,3]
%\end{karnaugh-map}
%      \end{verbatim}
%      \columnbreak
%      \resizebox{\columnwidth}{!}{%
%        \begin{karnaugh-map}[4][4][4]
%          \implicant{0}{0}[0,1,2,3]
%        \end{karnaugh-map}%
%      }
%    \end{multicols}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\newcount\@karnaughmap@local@northwest@\relax
\newcount\@karnaughmap@local@southeast@\relax
\DeclareDocumentCommand{\implicant}{D(){} m m O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  % fetch new color
  \@karnaughmap@func@updatecolor@{}
  %
  \begingroup
    % parse per-implicant options (e.g. name=..., namestyle=...)
    \renewcommand{\@karnaughmap@var@implicantname@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamestyle@}{\scriptsize}%
    \renewcommand{\@karnaughmap@var@implicantnamepos@}{center}%
    \renewcommand{\@karnaughmap@var@implicantcolor@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamecolor@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamegap@}{1mm}%
    \renewcommand{\@karnaughmap@var@implicantnameangle@}{90}%
    \renewcommand{\@karnaughmap@var@implicantnamedistance@}{10mm}%
    \renewcommand{\@karnaughmap@var@implicantnamearrowstyle@}{->}%
    \setkeys{karnaugh-map-implicant}{#1}%
    \newcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@color@}%
    \newcommand{\@karnaughmap@local@implicantopacity@}{0.25}%
    \IfStrEq{\@karnaughmap@var@implicantcolor@}{}{}{%
      \renewcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@implicantcolor@}%
      \renewcommand{\@karnaughmap@local@implicantopacity@}{1.0}%
    }%
    % loop through specified sub maps
    \foreach \map in {#4} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % calculate cell number for the specified sub maps {[START]
          \@karnaughmap@local@northwest@=\map\relax
          \@karnaughmap@local@southeast@=\map\relax
          \multiply\@karnaughmap@local@northwest@ by 16\relax
          \multiply\@karnaughmap@local@southeast@ by 16\relax
          \advance\@karnaughmap@local@northwest@ by #2\relax
          \advance\@karnaughmap@local@southeast@ by #3\relax
        % [END]}
        % only fill marking when \@karnaughmap@var@bw@ = '0'
        \ifnum0=\@karnaughmap@var@bw@
          \fill[
            rounded corners=3pt,
            on background layer,
            fill=\@karnaughmap@local@implicantcolor@,
            fill opacity=\@karnaughmap@local@implicantopacity@,
          ] {
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)+(-0.3,0.3)$)
            rectangle
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)+(0.3,-0.3)$)
          };
        \fi
        \draw[
          rounded corners=3pt,
          draw=\@karnaughmap@local@implicantcolor@,
          draw opacity=1.0,
          \@karnaughmap@func@decimaltolinestyle@{\@karnaughmap@var@colorindex@},
        ] {
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)+(-0.3,0.3)$)
          rectangle
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)+(0.3,-0.3)$)
        };
        \@karnaughmap@func@debugcolor@{\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}}%

        % optional implicant name
        \IfStrEq{\@karnaughmap@var@implicantname@}{}{}{% 
          \newcommand{\@karnaughmap@local@namecolor@}{black}%
          \ifnum0=\@karnaughmap@var@bw@\relax
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@namecolor@}%
          \fi
          \IfStrEq{\@karnaughmap@var@implicantnamecolor@}{}{}{%
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@implicantnamecolor@}%
          }%
          \IfStrEq{\@karnaughmap@var@implicantnamepos@}{below}{%
            % place label under smallest minterm (numeric) among defining cells
            \@karnaughmap@local@target@=\@karnaughmap@local@northwest@\relax
            \ifnum\@karnaughmap@local@southeast@<\@karnaughmap@local@target@\relax
              \@karnaughmap@local@target@=\@karnaughmap@local@southeast@\relax
            \fi
            \node[anchor=north,text=\@karnaughmap@local@namecolor@] at ($( 
              \@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.south
            )+(0,-0.15)$) {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }{\IfStrEq{\@karnaughmap@var@implicantnamepos@}{outside}{%
            % place label outside and connect with an arrow that hits the implicant border
            \@karnaughmap@local@target@=\@karnaughmap@local@northwest@\relax
            \ifnum\@karnaughmap@local@southeast@<\@karnaughmap@local@target@\relax
              \@karnaughmap@local@target@=\@karnaughmap@local@southeast@\relax
            \fi
            \coordinate (kmapTmpTargetCenter) at (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.center);
            \path[name path=kmapTmpImplicantOutline]
              ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)+(-0.3,0.3) $)
              rectangle
              ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)+(0.3,-0.3) $);
            \coordinate (kmapTmpLabelPos) at
              ($ (kmapTmpTargetCenter)+(\@karnaughmap@var@implicantnameangle@: \@karnaughmap@var@implicantnamedistance@) $);
            \node[text=\@karnaughmap@local@namecolor@] (kmapTmpLabelNode) at (kmapTmpLabelPos)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
            \path[name path=kmapTmpArrowLine] (kmapTmpLabelNode.center) -- (kmapTmpTargetCenter);
            \path[name intersections={of=kmapTmpArrowLine and kmapTmpImplicantOutline, by=kmapTmpArrowHit}];
            \draw[
              draw=\@karnaughmap@local@namecolor@,
              \@karnaughmap@var@implicantnamearrowstyle@,
              shorten <=\@karnaughmap@var@implicantnamegap@,
            ] (kmapTmpLabelNode.center) -- (kmapTmpArrowHit);
          }{%
            \node[text=\@karnaughmap@local@namecolor@] at
              ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@northwest@}.center)!0.5!(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@southeast@}.center)$)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }}%
        }%
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
  \endgroup
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \newpage
% \begin{macro}{\implicantedge}
%    The |\implicantedge| command draws quadratic implicants with the middle of the implicant facing the edge of a submap either horizontally or vertically. The function is able to draw the same implicant on one or multiple submaps. However if the implicant shall be drawn on multiple submaps, \marg{northwest part - northwest cell}, \marg{northwest part - southeast cell}, \marg{southeast part - northwest cell}, \marg{southeast part - southeast cell} must be specified as if the implicant was to be drawn on the 0:th submap. When turned on, colorization is done automatically, following a global sequence of available colors.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\implicantedge|}                       & \\
%      \small{\parg{options}}                         & \small{See section \ref{sec:usage:options:implicant}. Default: ''''} \\
%      \small{\marg{northwest part - northwest cell}} & \small{The most northwest cell in the northwest part of the implicant} \\
%      \small{\marg{northwest part - southeast cell}} & \small{The most southeast cell in the northwest part of the implicant} \\
%      \small{\marg{southeast part - northwest cell}} & \small{The most northwest cell in the southeast part of the implicant} \\
%      \small{\marg{southeast part - southeast cell}} & \small{The most southeast cell in the southeast part of the implicant} \\
%      \small{\oarg{submaps}}                         & \small{Comma separated list of submaps the implicant should be drawn on. Default: ''0''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    \begin{multicols}{2}
%      [Horizontal implicant over the submap edge containing the cells 4, 6, 12, and 14.]
%      \begin{verbatim}
%\begin{karnaugh-map}
%  \implicantedge{4}{12}{6}{14}
%\end{karnaugh-map}
%      \end{verbatim}
%      \columnbreak
%      \resizebox{\columnwidth}{!}{%
%        \begin{karnaugh-map}
%          \implicantedge{4}{12}{6}{14}
%        \end{karnaugh-map}%
%      }
%    \end{multicols}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\newcount\@karnaughmap@local@testcaseone@\relax
\newcount\@karnaughmap@local@testcasetwo@\relax
\newcount\@karnaughmap@local@coordinateonecounter@\relax
\newcount\@karnaughmap@local@coordinatetwocounter@\relax
\DeclareDocumentCommand{\implicantedge}{D(){} m m m m O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  % fetch new color
  \@karnaughmap@func@updatecolor@{}
  %
  \begingroup
    % parse per-implicant options (e.g. name=..., namestyle=...)
    \renewcommand{\@karnaughmap@var@implicantname@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamestyle@}{\scriptsize}%
    \renewcommand{\@karnaughmap@var@implicantnamepos@}{center}%
    \renewcommand{\@karnaughmap@var@implicantcolor@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamecolor@}{}%
    \renewcommand{\@karnaughmap@var@implicantnamegap@}{1mm}%
    \renewcommand{\@karnaughmap@var@implicantnameangle@}{90}%
    \renewcommand{\@karnaughmap@var@implicantnamedistance@}{10mm}%
    \renewcommand{\@karnaughmap@var@implicantnamearrowstyle@}{->}%
    \setkeys{karnaugh-map-implicant}{#1}%
    \newcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@color@}%
    \IfStrEq{\@karnaughmap@var@implicantcolor@}{}{}{%
      \renewcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@implicantcolor@}%
    }%
    % helper variables {[START]
      \newcommand{\@karnaughmap@local@orientation@}{0} % '0' is a vertical and '1' is a horizontal implicant
      \newcommand{\@karnaughmap@local@coordinateone@}{0}
      \newcommand{\@karnaughmap@local@coordinatetwo@}{0}
      \newcommand{\@karnaughmap@local@mirror@}{1} % '1' or '-1' to mirror
      \newcommand{\@karnaughmap@local@bordercontent@}{}
      \newcommand{\@karnaughmap@local@fillcontent@}{}
    % [END]}
    % determinate if this is an horizontal or vertical implicant {[START]
      \@karnaughmap@local@testcaseone@=#2\relax
      \@karnaughmap@local@testcasetwo@=#2\relax
      \advance\@karnaughmap@local@testcaseone@ by -#3\relax
      \advance\@karnaughmap@local@testcasetwo@ by -#4\relax
      \ifnum\@karnaughmap@local@testcaseone@<0 \multiply\@karnaughmap@local@testcaseone@ by -1\relax\fi
      \ifnum\@karnaughmap@local@testcasetwo@<0 \multiply\@karnaughmap@local@testcasetwo@ by -1\relax\fi
      % test case one
      \ifnum\@karnaughmap@local@testcaseone@<\@karnaughmap@var@mapsizex@
        % this is a vertical implicant
        \renewcommand{\@karnaughmap@local@orientation@}{0}
      \else
        % this is a horizontal implicant
        \renewcommand{\@karnaughmap@local@orientation@}{1}
      \fi
      % test case two
      \ifnum\@karnaughmap@local@testcasetwo@<\@karnaughmap@var@mapsizex@
        % this is a vertical implicant
        \renewcommand{\@karnaughmap@local@orientation@}{1}
      \fi
    % [END]}
    % loop through specified sub maps
    \foreach \map in {#6} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % loop through both parts of the marking(ie. left and right part)
        \foreach \i in {0,1} {%
          % set parameters depending on the part of the marking(ie. left and right part) {[START]
            \ifnum\i=0
              \renewcommand{\@karnaughmap@local@coordinateone@}{#2}
              \renewcommand{\@karnaughmap@local@coordinatetwo@}{#3}
              \renewcommand{\@karnaughmap@local@mirror@}{1}
            \else
              \renewcommand{\@karnaughmap@local@coordinateone@}{#4}
              \renewcommand{\@karnaughmap@local@coordinatetwo@}{#5}
              \renewcommand{\@karnaughmap@local@mirror@}{-1}
            \fi
          % [END]}
          % calculate cell numbers for the specified sub map {[START]
            \@karnaughmap@local@coordinateonecounter@=\map\relax
            \@karnaughmap@local@coordinatetwocounter@=\map\relax
            \multiply\@karnaughmap@local@coordinateonecounter@ by 16\relax
            \multiply\@karnaughmap@local@coordinatetwocounter@ by 16\relax
            \advance\@karnaughmap@local@coordinateonecounter@ by \@karnaughmap@local@coordinateone@\relax
            \advance\@karnaughmap@local@coordinatetwocounter@ by \@karnaughmap@local@coordinatetwo@\relax
            \renewcommand{\@karnaughmap@local@coordinateone@}{\@karnaughmap@local@coordinateonecounter@}
            \renewcommand{\@karnaughmap@local@coordinatetwo@}{\@karnaughmap@local@coordinatetwocounter@}
          % [END]}
          % select drawing content depending on orientation {[START]
            \ifnum\@karnaughmap@local@orientation@=0
              % this is a vertical implicant
              \renewcommand{\@karnaughmap@local@fillcontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,.6*\@karnaughmap@local@mirror@)$)
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,.6*\@karnaughmap@local@mirror@)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,-.3*\@karnaughmap@local@mirror@)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,-.3*\@karnaughmap@local@mirror@)$) }
                -- cycle
              }
              \renewcommand{\@karnaughmap@local@bordercontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,.6*\@karnaughmap@local@mirror@)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3,-.3*\@karnaughmap@local@mirror@)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,-.3*\@karnaughmap@local@mirror@)$) }
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.3,.6*\@karnaughmap@local@mirror@)$)
              }
            \else
              % this is a horizontal implicant
              \renewcommand{\@karnaughmap@local@fillcontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(-.6*\@karnaughmap@local@mirror@,-.3)$)
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.6*\@karnaughmap@local@mirror@,.3)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(.3*\@karnaughmap@local@mirror@,.3)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3*\@karnaughmap@local@mirror@,-.3)$) }
                -- cycle
              }
              \renewcommand{\@karnaughmap@local@bordercontent@}{%
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(-.6*\@karnaughmap@local@mirror@,.3)$)
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}.center)+(.3*\@karnaughmap@local@mirror@,.3)$) }
                { [rounded corners=3pt] --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(.3*\@karnaughmap@local@mirror@,-.3)$) }
                --
                ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinatetwo@}.center)+(-.6*\@karnaughmap@local@mirror@,-.3)$)
              }
            \fi
          % [END]}
          % draw
          % only fill marking when \@karnaughmap@var@bw@ = '0'
          \ifnum0=\@karnaughmap@var@bw@
            \fill[
              sharp corners,
              on background layer,
              fill=\@karnaughmap@local@implicantcolor@,
              fill opacity=0.25,
            ] {
              \@karnaughmap@local@fillcontent@%
            };
          \fi
          \draw[
            sharp corners,
            draw=\@karnaughmap@local@implicantcolor@,
            draw opacity=1.0,
            \@karnaughmap@func@decimaltolinestyle@{\@karnaughmap@var@colorindex@},
          ] {
            \@karnaughmap@local@bordercontent@%
          };
          \@karnaughmap@func@debugcolor@{\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinateone@}}%
        }

        % optional implicant name (placed at center of both parts)
        \IfStrEq{\@karnaughmap@var@implicantname@}{}{}{% 
          \newcommand{\@karnaughmap@local@namecolor@}{black}%
          \ifnum0=\@karnaughmap@var@bw@\relax
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@namecolor@}%
          \fi
          \IfStrEq{\@karnaughmap@var@implicantnamecolor@}{}{}{%
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@implicantnamecolor@}%
          }%
          \@karnaughmap@local@labela@=\map\relax
          \@karnaughmap@local@labelb@=\map\relax
          \@karnaughmap@local@labelc@=\map\relax
          \@karnaughmap@local@labeld@=\map\relax
          \multiply\@karnaughmap@local@labela@ by 16\relax
          \multiply\@karnaughmap@local@labelb@ by 16\relax
          \multiply\@karnaughmap@local@labelc@ by 16\relax
          \multiply\@karnaughmap@local@labeld@ by 16\relax
          \advance\@karnaughmap@local@labela@ by #2\relax
          \advance\@karnaughmap@local@labelb@ by #3\relax
          \advance\@karnaughmap@local@labelc@ by #4\relax
          \advance\@karnaughmap@local@labeld@ by #5\relax
          \IfStrEq{\@karnaughmap@var@implicantnamepos@}{below}{%
            % place label under smallest minterm (numeric) among defining cells
            \@karnaughmap@local@target@=\@karnaughmap@local@labela@\relax
            \ifnum\@karnaughmap@local@labelb@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labelb@\relax\fi
            \ifnum\@karnaughmap@local@labelc@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labelc@\relax\fi
            \ifnum\@karnaughmap@local@labeld@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labeld@\relax\fi
            \node[anchor=north,text=\@karnaughmap@local@namecolor@] at ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.south) + (0,-0.15) $)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }{\IfStrEq{\@karnaughmap@var@implicantnamepos@}{outside}{%
            % place label outside and connect with an arrow that hits the implicant border
            \@karnaughmap@local@target@=\@karnaughmap@local@labela@\relax
            \ifnum\@karnaughmap@local@labelb@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labelb@\relax\fi
            \ifnum\@karnaughmap@local@labelc@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labelc@\relax\fi
            \ifnum\@karnaughmap@local@labeld@<\@karnaughmap@local@target@\relax\@karnaughmap@local@target@=\@karnaughmap@local@labeld@\relax\fi
            \newcommand{\@karnaughmap@local@arrowcoorone@}{\the\@karnaughmap@local@labela@}%
            \newcommand{\@karnaughmap@local@arrowcoortwo@}{\the\@karnaughmap@local@labelb@}%
            \newcommand{\@karnaughmap@local@arrowmirror@}{1}%
            \ifnum\@karnaughmap@local@target@=\@karnaughmap@local@labelc@\relax
              \renewcommand{\@karnaughmap@local@arrowcoorone@}{\the\@karnaughmap@local@labelc@}%
              \renewcommand{\@karnaughmap@local@arrowcoortwo@}{\the\@karnaughmap@local@labeld@}%
              \renewcommand{\@karnaughmap@local@arrowmirror@}{-1}%
            \fi
            \ifnum\@karnaughmap@local@target@=\@karnaughmap@local@labeld@\relax
              \renewcommand{\@karnaughmap@local@arrowcoorone@}{\the\@karnaughmap@local@labelc@}%
              \renewcommand{\@karnaughmap@local@arrowcoortwo@}{\the\@karnaughmap@local@labeld@}%
              \renewcommand{\@karnaughmap@local@arrowmirror@}{-1}%
            \fi
            \coordinate (kmapTmpTargetCenter) at (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.center);
            \ifnum\@karnaughmap@local@orientation@=0
              \path[name path=kmapTmpImplicantOutline]
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoorone@}.center)+(-.3,.6*\@karnaughmap@local@arrowmirror@) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoortwo@}.center)+(.3,.6*\@karnaughmap@local@arrowmirror@) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoortwo@}.center)+(.3,-.3*\@karnaughmap@local@arrowmirror@) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoorone@}.center)+(-.3,-.3*\@karnaughmap@local@arrowmirror@) $) -- cycle;
            \else
              \path[name path=kmapTmpImplicantOutline]
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoortwo@}.center)+(-.6*\@karnaughmap@local@arrowmirror@,-.3) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoorone@}.center)+(-.6*\@karnaughmap@local@arrowmirror@,.3) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoorone@}.center)+(.3*\@karnaughmap@local@arrowmirror@,.3) $) --
                ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@arrowcoortwo@}.center)+(.3*\@karnaughmap@local@arrowmirror@,-.3) $) -- cycle;
            \fi
            \coordinate (kmapTmpLabelPos) at
              ($ (kmapTmpTargetCenter)+(\@karnaughmap@var@implicantnameangle@: \@karnaughmap@var@implicantnamedistance@) $);
            \node[text=\@karnaughmap@local@namecolor@] (kmapTmpLabelNode) at (kmapTmpLabelPos)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
            \path[name path=kmapTmpArrowLine] (kmapTmpLabelNode.center) -- (kmapTmpTargetCenter);
            \path[name intersections={of=kmapTmpArrowLine and kmapTmpImplicantOutline, by=kmapTmpArrowHit}];
            \draw[
              draw=\@karnaughmap@local@namecolor@,
              \@karnaughmap@var@implicantnamearrowstyle@,
              shorten <=\@karnaughmap@var@implicantnamegap@,
            ] (kmapTmpLabelNode.center) -- (kmapTmpArrowHit);
          }{%
            \node[text=\@karnaughmap@local@namecolor@] at
              ($($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@labela@}.center)!0.5!(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@labelb@}.center) $)!0.5!($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@labelc@}.center)!0.5!(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@labeld@}.center) $)$)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }}%
        }%
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
  \endgroup
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \newpage
% \begin{macro}{\implicantcorner}
%    The |\implicantcorner| command draws an implicant around only the four corner pieces on one or multiple four variable karnaugh submaps. When turned on, colorization is done automatically, following a global sequence of available colors.
%
%    \textbf{Usage:}
%
%    \begin{tabularx}{\textwidth}{l X}
%      \small{|\implicantcorner|} & \\
%      \small{\parg{options}}     & \small{See section \ref{sec:usage:options:implicant}. Default: ''''} \\
%      \small{\oarg{submaps}}     & \small{Comma separated list of submaps the implicant should be drawn on. Default: ''0''} \\
%    \end{tabularx}
%
%    \textbf{Example:}
%
%    \begin{multicols}{2}
%      [Draw an implicant around all corners on 0th and 2nd submap of a six variable karnaugh map.]
%      \begin{verbatim}
%\begin{karnaugh-map}[4][4][4]
%  \implicantcorner[0,2]
%\end{karnaugh-map}
%      \end{verbatim}
%      \columnbreak
%      \resizebox{\columnwidth}{!}{%
%        \begin{karnaugh-map}[4][4][4]
%          \implicantcorner[0,2]
%        \end{karnaugh-map}%
%      }
%    \end{multicols}
% \iffalse code
%    \begin{macrocode}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                              CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
\newcount\@karnaughmap@local@coordinate@\relax
\DeclareDocumentCommand{\implicantcorner}{D(){} O{0}} {%
  % bail if outside environment karnaugh-map
  \@karnaughmap@func@bailoutsideenvironment@{}
  %
  % make sure "\implicantcorner" only are used on 4x4 maps
  \ifnum\@karnaughmap@var@mapsizex@\@karnaughmap@var@mapsizey@=44
    % fetch new color
    \@karnaughmap@func@updatecolor@{}
    % parse per-implicant options (e.g. name=..., namestyle=...)
    \begingroup
      \renewcommand{\@karnaughmap@var@implicantname@}{}%
      \renewcommand{\@karnaughmap@var@implicantnamestyle@}{\scriptsize}%
      \renewcommand{\@karnaughmap@var@implicantnamepos@}{center}%
      \renewcommand{\@karnaughmap@var@implicantcolor@}{}%
      \renewcommand{\@karnaughmap@var@implicantnamecolor@}{}%
      \renewcommand{\@karnaughmap@var@implicantnamegap@}{1mm}%
      \renewcommand{\@karnaughmap@var@implicantnameangle@}{90}%
      \renewcommand{\@karnaughmap@var@implicantnamedistance@}{10mm}%
      \renewcommand{\@karnaughmap@var@implicantnamearrowstyle@}{->}%
      \setkeys{karnaugh-map-implicant}{#1}%
      \newcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@color@}%
      \IfStrEq{\@karnaughmap@var@implicantcolor@}{}{}{%
        \renewcommand{\@karnaughmap@local@implicantcolor@}{\@karnaughmap@var@implicantcolor@}%
      }%
    % loop through specified sub maps
    \foreach \map in {#2} {%
      % make sure we don't try to draw on non existing sub maps
      \ifnum\map<\@karnaughmap@var@mapsizez@
        % optional implicant name (once per submap, at submap center)
        \IfStrEq{\@karnaughmap@var@implicantname@}{}{}{% 
          \newcommand{\@karnaughmap@local@namecolor@}{black}%
          \ifnum0=\@karnaughmap@var@bw@\relax
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@namecolor@}%
          \fi
          \IfStrEq{\@karnaughmap@var@implicantnamecolor@}{}{}{%
            \renewcommand{\@karnaughmap@local@namecolor@}{\@karnaughmap@var@implicantnamecolor@}%
          }%
          \@karnaughmap@local@centerone@=\map\relax
          \@karnaughmap@local@centertwo@=\map\relax
          \multiply\@karnaughmap@local@centerone@ by 16\relax
          \multiply\@karnaughmap@local@centertwo@ by 16\relax
          \advance\@karnaughmap@local@centerone@ by 5\relax
          \advance\@karnaughmap@local@centertwo@ by 10\relax
          \IfStrEq{\@karnaughmap@var@implicantnamepos@}{below}{%
            % place label under smallest minterm in this implicant (corner 0 of the submap)
            \@karnaughmap@local@target@=\map\relax
            \multiply\@karnaughmap@local@target@ by 16\relax
            \node[anchor=north,text=\@karnaughmap@local@namecolor@] at ($ (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.south) + (0,-0.15) $)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }{\IfStrEq{\@karnaughmap@var@implicantnamepos@}{outside}{%
            % place label outside and connect with an arrow that hits the implicant border
            \@karnaughmap@local@target@=\map\relax
            \multiply\@karnaughmap@local@target@ by 16\relax
            \coordinate (kmapTmpTargetCenter) at (\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@target@}.center);
            \path[name path=kmapTmpImplicantOutline]
              ($ (kmapTmpTargetCenter)+(-.6,.6) $) --
              ($ (kmapTmpTargetCenter)+(.3,.6) $) --
              ($ (kmapTmpTargetCenter)+(.3,-.3) $) --
              ($ (kmapTmpTargetCenter)+(-.6,-.3) $) -- cycle;
            \coordinate (kmapTmpLabelPos) at
              ($ (kmapTmpTargetCenter)+(\@karnaughmap@var@implicantnameangle@: \@karnaughmap@var@implicantnamedistance@) $);
            \node[text=\@karnaughmap@local@namecolor@] (kmapTmpLabelNode) at (kmapTmpLabelPos)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
            \path[name path=kmapTmpArrowLine] (kmapTmpLabelNode.center) -- (kmapTmpTargetCenter);
            \path[name intersections={of=kmapTmpArrowLine and kmapTmpImplicantOutline, by=kmapTmpArrowHit}];
            \draw[
              draw=\@karnaughmap@local@namecolor@,
              \@karnaughmap@var@implicantnamearrowstyle@,
              shorten <=\@karnaughmap@var@implicantnamegap@,
            ] (kmapTmpLabelNode.center) -- (kmapTmpArrowHit);
          }{%
            \node[text=\@karnaughmap@local@namecolor@] at
              ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@centerone@}.center)!0.5!(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@centertwo@}.center)$)
              {{\@karnaughmap@var@implicantnamestyle@ \@karnaughmap@var@implicantname@}};
          }}%
        }%
        % loop through the four corners
        \foreach \corner in {0,2,8,10} {%
          % calculate corner's properties {[START]
            \@karnaughmap@local@coordinate@=\map\relax
            \multiply\@karnaughmap@local@coordinate@ by 16\relax
            \advance\@karnaughmap@local@coordinate@ by \corner\relax
            \newcommand{\@karnaughmap@local@mirrorx@}{0} % '1' or '-1' to mirror
            \newcommand{\@karnaughmap@local@mirrory@}{0} % '1' or '-1' to mirror
            \ifnum\corner=0 \renewcommand{\@karnaughmap@local@mirrorx@}{1}\renewcommand{\@karnaughmap@local@mirrory@}{1}\fi
            \ifnum\corner=2 \renewcommand{\@karnaughmap@local@mirrorx@}{-1}\renewcommand{\@karnaughmap@local@mirrory@}{1}\fi
            \ifnum\corner=8 \renewcommand{\@karnaughmap@local@mirrorx@}{1}\renewcommand{\@karnaughmap@local@mirrory@}{-1}\fi
            \ifnum\corner=10 \renewcommand{\@karnaughmap@local@mirrorx@}{-1}\renewcommand{\@karnaughmap@local@mirrory@}{-1}\fi
          % [END]}
          % draw
          % only fill marking when \@karnaughmap@var@bw@ = '0'
          \ifnum0=\@karnaughmap@var@bw@
            \fill[
              sharp corners,
              on background layer,
              fill=\@karnaughmap@local@implicantcolor@,
              fill opacity=0.25,
            ]
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
            --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
            { [rounded corners=3pt] --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$) }
            --
            ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$)
            -- cycle;
          \fi
          \draw[
            sharp corners,
            draw=\@karnaughmap@local@implicantcolor@,
            draw opacity=1.0,
            \@karnaughmap@func@decimaltolinestyle@{\@karnaughmap@var@colorindex@},
          ]
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,.6*\@karnaughmap@local@mirrory@)$)
          { [rounded corners=3pt] --
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(.3*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$) }
          --
          ($(\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}.center)+(-.6*\@karnaughmap@local@mirrorx@,-.3*\@karnaughmap@local@mirrory@)$);
          \@karnaughmap@func@debugcolor@{\@karnaughmap@func@decimaltobin@{\@karnaughmap@local@coordinate@}}%
        }
      \else
        \PackageWarning{karnaugh-map}{%
          You can only draw on existing sub maps.
          Ignoring instruction to draw on non existing sub map number \map%
        }
      \fi
    }
    \endgroup
  \else
    % print error if "\implicantcorner" are used on non 4x4 map
    \PackageError{karnaugh-map}{%
      \protect\implicantcorner\space can only be used on 4x4 maps%
    }{%
      You are trying to use \protect\implicantcorner\space on non 4x4 map.%
    }
  \fi
}
% ^^A ##########################################################################
% ^^A ##########################################################################
% ^^A ####                             /CODE                                ####
% ^^A ##########################################################################
% ^^A ##########################################################################
%    \end{macrocode}
% \fi
% \end{macro}
%
% \newpage
% \subsection{Options}\label{sec:usage:options}
% There are two available method for customizing the package, either globally or locally to one |karnaugh-map| environment. Multiple options are comma separated. The global options are defined when the package is loaded.
%    \begin{verbatim}
%\usepackage[options]{karnaugh-map}
%\end{verbatim}
%
% The local options, which have precedence over the global options, are defined when a |karnaugh-map| environment is started.
%
%    \begin{verbatim}
%\begin{karnaugh-map}(options)
%\end{karnaugh-map}
%\end{verbatim}
%
% \textbf{Available options are:}
%
% \texttt{implicantcolors}: Use this option to specify a comma separated list of implicant colors to be used. Each color is used in order and only once per map, when there are no colors left the remaining implicants are colored in \texttt{cyan}. Note; the opacity of the colors are turned down. Default: \texttt{\{red,green,yellow,cyan,blue,magenta\}}.
% \changes{v2.0}{2021/12/15}{Support custom implicant colors}
%
% \begin{figure}[H]
%   \centering
%   \resizebox{.25\textwidth}{!}{%
%     \begin{karnaugh-map}(implicantcolors={orange,violet})[2][2][1]
%       \minterms{1,2}
%       \autoterms[0]
%       \implicant{1}{1}
%       \implicant{2}{2}
%     \end{karnaugh-map}%
%   }
% \end{figure}
%
% \texttt{label}: The input variable labels can either be positioned on the top and the side of the karnaugh-map(\texttt{label=middle}). Alternatively they can be positioned in the top--left corner(\texttt{label=corner}) or using curly braces(\texttt{label=braces}). Default: \texttt{middle}.
% \changes{v2.0}{2018/11/20}{Support alternate input label position}
%
% \begin{figure}[H]
%   \centering
%   \resizebox{.95\textwidth}{!}{%
%     \begin{karnaugh-map}
%     \end{karnaugh-map}%
%     \begin{karnaugh-map}(label=corner)
%     \end{karnaugh-map}%
%     \begin{karnaugh-map}(label=braces)
%     \end{karnaugh-map}%
%   }
% \end{figure}
%
% \texttt{labelsep}: The separator used between variable labels when they are combined (e.g., for maps with 3 or more variables). Default: \texttt{''}.
%
% \texttt{linestyles}: The implicants can be drawn using different line styles to help visually differentiate them further. This is especially useful when printing in black and white or if colorblind accessibility is wanted. Experimental; the actual line styles used are subject to change. Default: \texttt{false}.
%
% \begin{figure}[H]
%   \centering
%   \begin{karnaugh-map}(linestyles)[2][2][1][$X_0$][$X_1$]
%     \implicant{1}{1}
%     \implicant{2}{2}
%     \implicant{1}{3}
%   \end{karnaugh-map}
%   \begin{karnaugh-map}(linestyles)*[2][2][1][$X_0$][$X_1$]
%     \implicant{1}{1}
%     \implicant{2}{2}
%     \implicant{1}{3}
%   \end{karnaugh-map}
% \end{figure}
%
% \texttt{mintermnames}: Show the decimal index of each cell in its bottom-right corner. Default: \texttt{true}.
%
% \texttt{debugcolors}: Show the color name of each implicant. Default: \texttt{false}.
%
% \newpage
% \subsection{Implicant Options}\label{sec:usage:options:implicant}
% The implicant related commands (\texttt{\textbackslash implicant}, \texttt{\textbackslash implicantedge}, \texttt{\textbackslash implicantcorner}) also support local options.
%
%    \begin{verbatim}
%\implicant(options){...}{...}
%\end{verbatim}
%
% \textbf{Available options are:}
%
% \texttt{name}: A label to be placed on or near the implicant.
%
% \texttt{namepos}: Where to put the label. Available values are \texttt{center} (default), \texttt{below}, and \texttt{outside} (placing it outside with an arrow).
%
% \texttt{namestyle}: TikZ style for the name label.
%
% \texttt{color}: Overrides the automatic color for this implicant.
%
% \texttt{namecolor}: Overrides the color for the name label (defaults to the implicant color).
%
% \texttt{nameangle}: The angle from the implicant center where the name should be placed if \texttt{namepos=outside}.
%
% \texttt{namedistance}: The distance from the implicant center where the name should be placed if \texttt{namepos=outside}.
%
% \texttt{namegap}: The gap between the arrow and the name label.
%
% \texttt{namearrowstyle}: TikZ style for the arrow.
%
% \newpage
% \section{Examples}
%   \begin{multicols}{2}
%     [Draw a karnaugh map for \small{$f(a,b,c,d,e,f) =$\\$\Sigma(0,1,2,3,8,13,17,20,22,28,33,32,30,19,40,35,49,42,34,10,60,54,62,51,52)$\\$+d(15,45,47)$}.]
%     \begin{verbatim}
%\begin{karnaugh-map}[4][4][4][$a$][$b$][$c$][$d$][$e$][$f$]
%  \minterms{0,1,2,3,8,13,17,20,22,28,
%    33,32,30,19,40,35,49,42,34,10,60,
%    54,62,51,52}
%  \indeterminants{15,45,47}
%  \autoterms[0]
%  \implicantcorner[0,2]
%  \implicant{1}{3}[0,1,2,3]
%  \implicantedge{4}{12}{6}{14}[1,3]
%  \implicant{13}{15}[0,2]
%\end{karnaugh-map}
%     \end{verbatim}
%     \columnbreak
%     \vspace*{0.25em}
%     \resizebox{\columnwidth}{!}{%
%       \begin{karnaugh-map}[4][4][4][$a$][$b$][$c$][$d$][$e$][$f$]
%         \minterms{0,1,2,3,8,13,17,20,22,28,33,32,30,19,40,35,49,42,34,10,60,54,62,51,52}
%         \indeterminants{15,45,47}
%         \autoterms[0]
%         \implicantcorner[0,2]
%         \implicant{1}{3}[0,1,2,3]
%         \implicantedge{4}{12}{6}{14}[1,3]
%         \implicant{13}{15}[0,2]
%       \end{karnaugh-map}%
%     }
%   \end{multicols}
%
%   \begin{multicols}{2}
%     [Draw a karnaugh map for \small{$f(X_0,X_1) = \Pi(0,2,3)$} in black and white.]
%     \begin{verbatim}
%\begin{karnaugh-map}*[2][2][1]
%  \maxterms{0,2,3}
%  \autoterms[1]
%  \implicant{1}{1}
%\end{karnaugh-map}
%     \end{verbatim}
%     \columnbreak
%     \resizebox{\columnwidth}{!}{%
%       \begin{karnaugh-map}*[2][2][1]
%         \maxterms{0,2,3}
%         \autoterms[1]
%         \implicant{1}{1}
%       \end{karnaugh-map}%
%     }
%   \end{multicols}
%
%   \begin{multicols}{2}
%     [Draw a karnaugh map for $f(x,y) = x + y'$ with named implicants.]
%     \begin{verbatim}
%\begin{karnaugh-map}(label=braces)[2][2][1][$y$][$x$]
%  \minterms{0,2,3}
%  \autoterms[-]
%  \implicant(name=$y'$,namepos=outside,
%    nameangle=230,namedistance=25mm){0}{2}
%  \implicant(name=$x$,namepos=outside,
%    nameangle=30,namedistance=25mm){2}{3}
%\end{karnaugh-map}
%     \end{verbatim}
%     \columnbreak
%     \resizebox{\columnwidth}{!}{%
%       \begin{karnaugh-map}(label=braces)[2][2][1][$y$][$x$]
%         \minterms{0,2,3}
%         \autoterms[-]
%         \implicant(name=$y'$,namepos=outside,nameangle=230,namedistance=25mm){0}{2}
%         \implicant(name=$x$,namepos=outside,nameangle=30,namedistance=25mm){2}{3}
%       \end{karnaugh-map}%
%     }
%   \end{multicols}
%
%   \newpage
%   \begin{multicols}{2}
%     [Draw a variable entered map.]
%     \begin{verbatim}
%\begin{karnaugh-map}[4][2][1][$a$][$b$][$c$]
%  \maxterms{0,2,4,5,6}
%  \minterms{3}
%  \terms{1}{$d$}
%  \terms{7}{$d'$}
%  \implicant{1}{3}
%  \implicant{3}{7}
%\end{karnaugh-map}
%     \end{verbatim}
%     \columnbreak
%     \resizebox{\columnwidth}{!}{%
%       \begin{karnaugh-map}[4][2][1][$a$][$b$][$c$]
%         \maxterms{0,2,4,5,6}
%         \minterms{3}
%         \terms{1}{$d$}
%         \terms{7}{$d'$}
%         \implicant{1}{3}
%         \implicant{3}{7}
%       \end{karnaugh-map}%
%     }
%   \end{multicols}
%
% \section{Dependencies}
% \begin{itemize}
%   \item keyval
%   \item kvoptions
%   \item tikz
%   \item xparse
%   \item xstring
% \end{itemize}
%
% \newpage
% \section{Miscellaneous}
% \subsection*{Resizing}
% The karnaugh maps produced with this package have a prespecified size which can not be changed. However you can resize the karnaugh map to your desired size. Resizing can be done using the |\resizebox| command from the graphicx package. Scaling the karnaugh map to fill the column width while preserving the aspect ratio can be done as follows.
% \begin{verbatim}
%\resizebox{\columnwidth}{!}{%
%  \begin{karnaugh-map}
%  \end{karnaugh-map}%
%}
% \end{verbatim}
%
% \subsection*{Comma separated lists}
% Anywhere in this package where a comma separated list is used data should only be comma separated. Therefore a comma and space separated list will for example \textit{not} work properly.
%
% An example of errorious usage related to the \small{\marg{cells}} parameter in the terms related commands can result in multiple zeros, ones and other terms overlapping in the same cell in the outputted karnaugh map.
%
\endinput
